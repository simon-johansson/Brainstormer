
// http://codepen.io/PageOnline/pen/GCbte
// var image = "data:image/gif;base64,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";

// function upload() {
//   var dataURL = c.toDataURL('image/jpeg', 0.5);
//   var blob = dataURItoBlob(dataURL);
//   var fd = new FormData();
//   fd.append("file", blob);
// }

function dataURItoBlob(dataURI) {
    // convert base64/URLEncoded data component to raw binary data held in a string
    var byteString;
    if (dataURI.split(',')[0].indexOf('base64') >= 0)
        byteString = atob(dataURI.split(',')[1]);
    else
        byteString = unescape(dataURI.split(',')[1]);

    // separate out the mime component
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

    // write the bytes of the string to a typed array
    var ia = new Uint8Array(byteString.length);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }

    return new Blob([ia], {type:mimeString});
}

var listToAdd = '';
var memberId = '';
var $boardsForm = $('.boards');
var $selectBoards = $('.select-boards');
var $listsForm = $('.lists');
var $selectLists = $('.select-lists');
var $cardForm = $('.card');
var $cardText = $('#title');
var $createCard = $('.create-card');
var $loading = $('.loading');

$selectBoards.on('change', function(event) {
  event.preventDefault();
  Trello.get(
    '/boards/' + $(this).val() + '/lists',
    loadedLists,
    function() { console.log("Failed to load lists"); }
  );
});

$selectLists.on('change', function(event) {
  event.preventDefault();
  listToAdd = $(this).val();
  $cardForm.removeClass('hidden');
});

$createCard.on('click', function(event) {
  event.preventDefault();
  var cardText = $cardText.val();
  if (cardText) {

    var newCard = {
      name: cardText,
      idList: listToAdd,
      pos: 'top',
      idMembers: memberId,
      // fileSource: fd,
      // urlSource: "http://www.productivity501.com/wp-content/uploads/2009/06/picture-9.png",
    };
    Trello.post('/cards/', newCard, cardCreationSuccess);
  }
});

var cardCreationSuccess = function(data) {
  // console.log('Card created successfully. Data returned:' + JSON.stringify(data));

  var canvas = document.getElementById("canvas");
  var dataURL = canvas.toDataURL('image/png', 1.0);
  // console.log(dataURL);
  var blob = dataURItoBlob(dataURL);
  // console.log(blob);
  var fd = new FormData();
  fd.append("key", Trello.key());
  fd.append("token", Trello.token());
  fd.append("file", blob, 'filename.png');

  $loading.removeClass('hidden');

  $.ajax({
    url: 'https://api.trello.com/1/cards/' + data.id + '/attachments',
    type: 'POST',
    dataType: 'json',
    processData: false,
    contentType: false,
    data: fd,
  })
  .done(function() {
    clear();
    $cardText.val('');
    $loading.addClass('hidden');
  })
  .fail(function() {
    console.log("error");
    $loading.text('Error!');
  })

  // var request = new XMLHttpRequest();
  // request.open("POST", "https://api.trello.com/1/cards/" + data.id + "/attachments");
  // request.send(fd);

  // Trello.post('/cards/' + data.id + '/attachments/', {
  //     file: fd
  //   },
  //   function (data) {
  //     console.log(data);
  //   },
  //   function (err) {
  //     console.log(err);
  //   });
};

var loadedLists = function(lists) {
  $listsForm.removeClass('hidden');
  var activeLists = _.filter(lists, {closed: false});
  $.each(activeLists, function(index, value) {
    $selectLists
      .append($("<option></option>")
      .attr("value", value.id)
      .text(value.name));
  });
};

var loadedBoards = function(boards) {
  // console.log(boards);
  var activeBoards = _.filter(boards, {closed: false});
  $.each(activeBoards, function(index, value) {
    $selectBoards
      .append($("<option></option>")
      .attr("value", value.id)
      .text(value.name));
  });
};

var authenticationSuccess = function(data) {
  Trello.get(
    '/members/me/boards/',
    loadedBoards,
    function() {
      console.log("Failed to load boards");
    }
  );
  Trello.get(
    '/members/me/',
    function (data) {
      memberId = data.id;
    },
    function() {
      console.log("Failed to load member id");
    }
  );
};

Trello.authorize({
  type: 'redirect',
  name: 'Brainstorming',
  scope: {
    read: 'true',
    write: 'true'
  },
  expiration: 'never',
  success: authenticationSuccess,
  error: function (err) {
    console.log('Failed authentication', err)
  }
});
